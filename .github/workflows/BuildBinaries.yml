name: Build Binaries

on: workflow_dispatch

jobs:
  windows-x86:
    runs-on: windows-latest
    env:
      POWERSHELL_TELEMETRY_OPTOUT: 1
    steps:
    - name: Clone repository
      shell: cmd
      run: |
          mkdir C:\workspaces
          cd /d C:\workspaces
          git clone --recurse-submodules --depth 1 --shallow-submodules --branch main --single-branch --no-tags --progress --verbose https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/cxxzhang/qt5.15.17
    - name: Set up VC-LTL
      shell: cmd
      working-directory: C:\workspaces\qt5.15.17
      run: call C:\workspaces\qt5.15.17\.github\workflows\setup-vc-ltl.bat
    - name: Build qt5
      shell: cmd
      working-directory: C:\workspaces\qt5.15.17
      run: |
          git config --global user.email "ci@github-actions.com"
          git config --global user.name "GitHub Actions"
          call C:\workspaces\qt5.15.17\apply-patches.bat
          call C:\workspaces\qt5.15.17\onekey-build-windows-x86.bat
    - uses: actions/upload-artifact@v4
      with:
        name: qt5.15.17_x86
        path: C:\workspaces\qt5.15.17\Output\x86

  windows-x64:
    runs-on: windows-latest
    env:
      POWERSHELL_TELEMETRY_OPTOUT: 1
    steps:
    - name: Clone repository
      shell: cmd
      run: |
          mkdir C:\workspaces
          cd /d C:\workspaces
          git clone --recurse-submodules --depth 1 --shallow-submodules --branch main --single-branch --no-tags --progress --verbose https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/cxxzhang/qt5.15.17
    - name: Set up VC-LTL
      shell: cmd
      working-directory: C:\workspaces\qt5.15.17
      run: call C:\workspaces\qt5.15.17\.github\workflows\setup-vc-ltl.bat
    - name: Build qt5
      shell: cmd
      working-directory: C:\workspaces\qt5.15.17
      run: |
          git config --global user.email "ci@github-actions.com"
          git config --global user.name "GitHub Actions"
          call C:\workspaces\qt5.15.17\apply-patches.bat
          call C:\workspaces\qt5.15.17\onekey-build-windows-x64.bat
    - uses: actions/upload-artifact@v4
      with:
        name: qt5.15.17_x64
        path: C:\workspaces\qt5.15.17\Output\x64

  windows-arm64:
    runs-on: windows-11-arm
    env:
      POWERSHELL_TELEMETRY_OPTOUT: 1
    steps:
    - name: Clone repository
      shell: cmd
      run: |
          mkdir C:\workspaces
          cd /d C:\workspaces
          git clone --recurse-submodules --depth 1 --shallow-submodules --branch main --single-branch --no-tags --progress --verbose https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/cxxzhang/qt5.15.17
    - name: Set up VC-LTL
      shell: cmd
      working-directory: C:\workspaces\qt5.15.17
      run: call C:\workspaces\qt5.15.17\.github\workflows\setup-vc-ltl.bat
    - name: Build qt5 arm64
      shell: cmd
      working-directory: C:\workspaces\qt5.15.17
      run: |
          git config --global user.email "ci@github-actions.com"
          git config --global user.name "GitHub Actions"
          call C:\workspaces\qt5.15.17\apply-patches.bat
          call C:\workspaces\qt5.15.17\onekey-build-windows-arm64.bat
    - uses: actions/upload-artifact@v4
      with:
        name: qt5.15.17_arm64
        path: C:\workspaces\qt5.15.17\Output\arm64

  windows-x86-debug:
    runs-on: windows-latest
    env:
      POWERSHELL_TELEMETRY_OPTOUT: 1
    steps:
    - name: Clone repository
      shell: cmd
      run: |
          mkdir C:\workspaces
          cd /d C:\workspaces
          git clone --recurse-submodules --depth 1 --shallow-submodules --branch main --single-branch --no-tags --progress --verbose https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/cxxzhang/qt5.15.17
    - name: Set up VC-LTL
      shell: cmd
      working-directory: C:\workspaces\qt5.15.17
      run: call C:\workspaces\qt5.15.17\.github\workflows\setup-vc-ltl.bat
    - name: Build qt5 debug x86
      shell: cmd
      working-directory: C:\workspaces\qt5.15.17
      run: |
          git config --global user.email "ci@github-actions.com"
          git config --global user.name "GitHub Actions"
          call C:\workspaces\qt5.15.17\apply-patches.bat
          call C:\workspaces\qt5.15.17\onekey-build-windows-x86-debug.bat
    - uses: actions/upload-artifact@v4
      with:
        name: qt5.15.17_x86_debug
        path: C:\workspaces\qt5.15.17\Output\x86d

  windows-x64-debug:
    runs-on: windows-latest
    env:
      POWERSHELL_TELEMETRY_OPTOUT: 1
    steps:
    - name: Clone repository
      shell: cmd
      run: |
          mkdir C:\workspaces
          cd /d C:\workspaces
          git clone --recurse-submodules --depth 1 --shallow-submodules --branch main --single-branch --no-tags --progress --verbose https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/cxxzhang/qt5.15.17
    - name: Set up VC-LTL
      shell: cmd
      working-directory: C:\workspaces\qt5.15.17
      run: call C:\workspaces\qt5.15.17\.github\workflows\setup-vc-ltl.bat
    - name: Build qt5 debug x64
      shell: cmd
      working-directory: C:\workspaces\qt5.15.17
      run: |
          git config --global user.email "ci@github-actions.com"
          git config --global user.name "GitHub Actions"
          call C:\workspaces\qt5.15.17\apply-patches.bat
          call C:\workspaces\qt5.15.17\onekey-build-windows-x64-debug.bat
    - uses: actions/upload-artifact@v4
      with:
        name: qt5.15.17_x64_debug
        path: C:\workspaces\qt5.15.17\Output\x64d

  windows-arm64-debug:
    runs-on: windows-11-arm
    env:
      POWERSHELL_TELEMETRY_OPTOUT: 1
    steps:
    - name: Clone repository
      shell: cmd
      run: |
          mkdir C:\workspaces
          cd /d C:\workspaces
          git clone --recurse-submodules --depth 1 --shallow-submodules --branch main --single-branch --no-tags --progress --verbose https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/cxxzhang/qt5.15.17
    - name: Set up VC-LTL
      shell: cmd
      working-directory: C:\workspaces\qt5.15.17
      run: call C:\workspaces\qt5.15.17\.github\workflows\setup-vc-ltl.bat
    - name: Build qt5 debug arm64
      shell: cmd
      working-directory: C:\workspaces\qt5.15.17
      run: |
          git config --global user.email "ci@github-actions.com"
          git config --global user.name "GitHub Actions"
          call C:\workspaces\qt5.15.17\apply-patches.bat
          call C:\workspaces\qt5.15.17\onekey-build-windows-arm64-debug.bat
    - uses: actions/upload-artifact@v4
      with:
        name: qt5.15.17_arm64_debug
        path: C:\workspaces\qt5.15.17\Output\arm64d

  linux-x64:
    runs-on: ubuntu-22.04
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 1
        token: ${{ secrets.GITHUB_TOKEN }}
    - name: Configure git user
      run: |
        git config --global user.email "ci@github-actions.com"
        git config --global user.name "GitHub Actions"
    - name: Build qt5 linux x64
      run: bash ./onekey-build-linux-x64.sh
    - uses: actions/upload-artifact@v4
      with:
        name: qt5.15.17_linux_x64
        path: ${{ github.workspace }}/Output/linux-x64

  linux-x64-debug:
    runs-on: ubuntu-22.04
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 1
        token: ${{ secrets.GITHUB_TOKEN }}
    - name: Configure git user
      run: |
        git config --global user.email "ci@github-actions.com"
        git config --global user.name "GitHub Actions"
    - name: Build qt5 linux x64 debug
      run: bash ./onekey-build-linux-x64-debug.sh
    - uses: actions/upload-artifact@v4
      with:
        name: qt5.15.17_linux_x64_debug
        path: ${{ github.workspace }}/Output/linux-x64-debug

  linux-arm64:
    runs-on: ubuntu-22.04-arm
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 1
        token: ${{ secrets.GITHUB_TOKEN }}
    - name: Configure git user
      run: |
        git config --global user.email "ci@github-actions.com"
        git config --global user.name "GitHub Actions"
    - name: Build qt5 linux arm64
      run: bash ./onekey-build-linux-arm64.sh
    - uses: actions/upload-artifact@v4
      with:
        name: qt5.15.17_linux_arm64
        path: ${{ github.workspace }}/Output/linux-arm64

  linux-arm64-debug:
    runs-on: ubuntu-22.04-arm
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 1
        token: ${{ secrets.GITHUB_TOKEN }}
    - name: Configure git user
      run: |
        git config --global user.email "ci@github-actions.com"
        git config --global user.name "GitHub Actions"
    - name: Build qt5 linux arm64 debug
      run: bash ./onekey-build-linux-arm64-debug.sh
    - uses: actions/upload-artifact@v4
      with:
        name: qt5.15.17_linux_arm64_debug
        path: ${{ github.workspace }}/Output/linux-arm64-debug

  macos-x64:
    runs-on: macos-13
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 1
        token: ${{ secrets.GITHUB_TOKEN }}
    - name: Configure git user
      run: |
        git config --global user.email "ci@github-actions.com"
        git config --global user.name "GitHub Actions"
    - name: Build qt5 macOS x64
      run: bash ./onekey-build-macos-x64.sh
    - uses: actions/upload-artifact@v4
      with:
        name: qt5.15.17_macos_x64
        path: ${{ github.workspace }}/Output/macos-x64

  macos-x64-debug:
    runs-on: macos-13
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 1
        token: ${{ secrets.GITHUB_TOKEN }}
    - name: Configure git user
      run: |
        git config --global user.email "ci@github-actions.com"
        git config --global user.name "GitHub Actions"
    - name: Build qt5 macOS x64 debug
      run: bash ./onekey-build-macos-x64-debug.sh
    - uses: actions/upload-artifact@v4
      with:
        name: qt5.15.17_macos_x64_debug
        path: ${{ github.workspace }}/Output/macos-x64-debug

  macos-arm64:
    runs-on: macos-14
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 1
        token: ${{ secrets.GITHUB_TOKEN }}
    - name: Configure git user
      run: |
        git config --global user.email "ci@github-actions.com"
        git config --global user.name "GitHub Actions"
    - name: Build qt5 macOS arm64
      run: bash ./onekey-build-macos-arm64.sh
    - uses: actions/upload-artifact@v4
      with:
        name: qt5.15.17_macos_arm64
        path: ${{ github.workspace }}/Output/macos-arm64

  macos-arm64-debug:
    runs-on: macos-14
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 1
        token: ${{ secrets.GITHUB_TOKEN }}
    - name: Configure git user
      run: |
        git config --global user.email "ci@github-actions.com"
        git config --global user.name "GitHub Actions"
    - name: Build qt5 macOS arm64 debug
      run: bash ./onekey-build-macos-arm64-debug.sh
    - uses: actions/upload-artifact@v4
      with:
        name: qt5.15.17_macos_arm64_debug
        path: ${{ github.workspace }}/Output/macos-arm64-debug

  release:
    needs: [windows-x86, windows-x64, windows-arm64, windows-x86-debug, windows-x64-debug, windows-arm64-debug, linux-x64, linux-x64-debug, linux-arm64, linux-arm64-debug, macos-x64, macos-x64-debug, macos-arm64, macos-arm64-debug]
    runs-on: ubuntu-latest
    steps:
    - name: Download x86 artifact
      uses: actions/download-artifact@v4
      with:
        name: qt5.15.17_x86
        path: ./release_assets/x86
    - name: Download x64 artifact
      uses: actions/download-artifact@v4
      with:
        name: qt5.15.17_x64
        path: ./release_assets/x64
    - name: Download arm64 artifact
      uses: actions/download-artifact@v4
      with:
        name: qt5.15.17_arm64
        path: ./release_assets/arm64
    - name: Download x86 debug artifact
      uses: actions/download-artifact@v4
      with:
        name: qt5.15.17_x86_debug
        path: ./release_assets/x86-debug
    - name: Download x64 debug artifact
      uses: actions/download-artifact@v4
      with:
        name: qt5.15.17_x64_debug
        path: ./release_assets/x64-debug
    - name: Download arm64 debug artifact
      uses: actions/download-artifact@v4
      with:
        name: qt5.15.17_arm64_debug
        path: ./release_assets/arm64-debug
    - name: Download linux x64 artifact
      uses: actions/download-artifact@v4
      with:
        name: qt5.15.17_linux_x64
        path: ./release_assets/linux-x64
    - name: Download linux x64 debug artifact
      uses: actions/download-artifact@v4
      with:
        name: qt5.15.17_linux_x64_debug
        path: ./release_assets/linux-x64-debug
    - name: Download linux arm64 artifact
      uses: actions/download-artifact@v4
      with:
        name: qt5.15.17_linux_arm64
        path: ./release_assets/linux-arm64
    - name: Download linux arm64 debug artifact
      uses: actions/download-artifact@v4
      with:
        name: qt5.15.17_linux_arm64_debug
        path: ./release_assets/linux-arm64-debug
    - name: Download macOS x64 artifact
      uses: actions/download-artifact@v4
      with:
        name: qt5.15.17_macos_x64
        path: ./release_assets/macos-x64
    - name: Download macOS x64 debug artifact
      uses: actions/download-artifact@v4
      with:
        name: qt5.15.17_macos_x64_debug
        path: ./release_assets/macos-x64-debug
    - name: Download macOS arm64 artifact
      uses: actions/download-artifact@v4
      with:
        name: qt5.15.17_macos_arm64
        path: ./release_assets/macos-arm64
    - name: Download macOS arm64 debug artifact
      uses: actions/download-artifact@v4
      with:
        name: qt5.15.17_macos_arm64_debug
        path: ./release_assets/macos-arm64-debug
    - name: Compress x86 to zip
      run: |
        cd release_assets/x86
        zip -r ../qt5.15.17_x86.zip .
    - name: Compress x64 to zip
      run: |
        cd release_assets/x64
        zip -r ../qt5.15.17_x64.zip .
    - name: Compress arm64 to zip
      run: |
        cd release_assets/arm64
        zip -r ../qt5.15.17_arm64.zip .
    - name: Compress x86 debug to zip
      run: |
        cd release_assets/x86-debug
        zip -r ../qt5.15.17_x86_debug.zip .
    - name: Compress x64 debug to zip
      run: |
        cd release_assets/x64-debug
        zip -r ../qt5.15.17_x64_debug.zip .
    - name: Compress arm64 debug to zip
      run: |
        cd release_assets/arm64-debug
        zip -r ../qt5.15.17_arm64_debug.zip .
    - name: Compress linux x64 to zip
      run: |
        cd release_assets/linux-x64
        zip -r ../qt5.15.17_linux_x64.zip .
    - name: Compress linux x64 debug to zip
      run: |
        cd release_assets/linux-x64-debug
        zip -r ../qt5.15.17_linux_x64_debug.zip .
    - name: Compress linux arm64 to zip
      run: |
        cd release_assets/linux-arm64
        zip -r ../qt5.15.17_linux_arm64.zip .
    - name: Compress linux arm64 debug to zip
      run: |
        cd release_assets/linux-arm64-debug
        zip -r ../qt5.15.17_linux_arm64_debug.zip .
    - name: Compress macOS x64 to zip
      run: |
        cd release_assets/macos-x64
        zip -r ../qt5.15.17_macos_x64.zip .
    - name: Compress macOS x64 debug to zip
      run: |
        cd release_assets/macos-x64-debug
        zip -r ../qt5.15.17_macos_x64_debug.zip .
    - name: Compress macOS arm64 to zip
      run: |
        cd release_assets/macos-arm64
        zip -r ../qt5.15.17_macos_arm64.zip .
    - name: Compress macOS arm64 debug to zip
      run: |
        cd release_assets/macos-arm64-debug
        zip -r ../qt5.15.17_macos_arm64_debug.zip .
    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      with:
        tag_name: qt5.15.17-${{ github.run_id }}
        release_name: qt5.15.17 Build ${{ github.run_id }}
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    - name: Upload x86 zip asset
      uses: actions/upload-release-asset@v1
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./release_assets/qt5.15.17_x86.zip
        asset_name: qt5.15.17_x86.zip
        asset_content_type: application/zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    - name: Upload x64 zip asset
      uses: actions/upload-release-asset@v1
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./release_assets/qt5.15.17_x64.zip
        asset_name: qt5.15.17_x64.zip
        asset_content_type: application/zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    - name: Upload arm64 zip asset
      uses: actions/upload-release-asset@v1
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./release_assets/qt5.15.17_arm64.zip
        asset_name: qt5.15.17_arm64.zip
        asset_content_type: application/zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    - name: Upload x86 debug zip asset
      uses: actions/upload-release-asset@v1
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./release_assets/qt5.15.17_x86_debug.zip
        asset_name: qt5.15.17_x86_debug.zip
        asset_content_type: application/zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    - name: Upload x64 debug zip asset
      uses: actions/upload-release-asset@v1
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./release_assets/qt5.15.17_x64_debug.zip
        asset_name: qt5.15.17_x64_debug.zip
        asset_content_type: application/zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    - name: Upload arm64 debug zip asset
      uses: actions/upload-release-asset@v1
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./release_assets/qt5.15.17_arm64_debug.zip
        asset_name: qt5.15.17_arm64_debug.zip
        asset_content_type: application/zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    - name: Upload linux x64 zip asset
      uses: actions/upload-release-asset@v1
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./release_assets/qt5.15.17_linux_x64.zip
        asset_name: qt5.15.17_linux_x64.zip
        asset_content_type: application/zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    - name: Upload linux x64 debug zip asset
      uses: actions/upload-release-asset@v1
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./release_assets/qt5.15.17_linux_x64_debug.zip
        asset_name: qt5.15.17_linux_x64_debug.zip
        asset_content_type: application/zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    - name: Upload linux arm64 zip asset
      uses: actions/upload-release-asset@v1
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./release_assets/qt5.15.17_linux_arm64.zip
        asset_name: qt5.15.17_linux_arm64.zip
        asset_content_type: application/zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    - name: Upload linux arm64 debug zip asset
      uses: actions/upload-release-asset@v1
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./release_assets/qt5.15.17_linux_arm64_debug.zip
        asset_name: qt5.15.17_linux_arm64_debug.zip
        asset_content_type: application/zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    - name: Upload macOS x64 zip asset
      uses: actions/upload-release-asset@v1
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./release_assets/qt5.15.17_macos_x64.zip
        asset_name: qt5.15.17_macos_x64.zip
        asset_content_type: application/zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    - name: Upload macOS x64 debug zip asset
      uses: actions/upload-release-asset@v1
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./release_assets/qt5.15.17_macos_x64_debug.zip
        asset_name: qt5.15.17_macos_x64_debug.zip
        asset_content_type: application/zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    - name: Upload macOS arm64 zip asset
      uses: actions/upload-release-asset@v1
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./release_assets/qt5.15.17_macos_arm64.zip
        asset_name: qt5.15.17_macos_arm64.zip
        asset_content_type: application/zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    - name: Upload macOS arm64 debug zip asset
      uses: actions/upload-release-asset@v1
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./release_assets/qt5.15.17_macos_arm64_debug.zip
        asset_name: qt5.15.17_macos_arm64_debug.zip
        asset_content_type: application/zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

